<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊúâÊ©üÂåñÂ≠¶„Éû„Çπ„Çø„Éº - Organic Chem Master</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Error Handling Style -->
    <style>
        #error-console {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 150px;
            background: rgba(0,0,0,0.8);
            color: #ffcccc;
            font-family: monospace;
            font-size: 10px;
            padding: 10px;
            overflow: auto;
            z-index: 9999;
        }
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #f0fdf4;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            font-family: sans-serif;
            color: #166534;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div style="font-size: 40px; margin-bottom: 20px;">‚öóÔ∏è</div>
        <div>„Ç¢„Éó„É™„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</div>
    </div>

    <!-- App Root -->
    <div id="root"></div>

    <!-- Error Console for Mobile Debugging -->
    <div id="error-console"></div>

    <script>
        // Global Error Handler for Mobile
        window.onerror = function(message, source, lineno, colno, error) {
            const consoleDiv = document.getElementById('error-console');
            consoleDiv.style.display = 'block';
            consoleDiv.innerHTML += `<div>[Error] ${message} (${source}:${lineno})</div>`;
            // Also hide loading screen if error occurs
            document.getElementById('loading-screen').innerHTML = 
                '<div style="color:red; padding:20px; text-align:center;">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ<br>ÁîªÈù¢‰∏ãÈÉ®„ÅÆ„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>';
        };
        
        // Catch unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            const consoleDiv = document.getElementById('error-console');
            consoleDiv.style.display = 'block';
            consoleDiv.innerHTML += `<div>[Promise Error] ${event.reason}</div>`;
        });
    </script>
    
    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, addDoc, query, where, orderBy, serverTimestamp, writeBatch, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Expose Firebase to window
        window.firebaseModules = { 
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut,
            getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, addDoc, query, where, orderBy, serverTimestamp, writeBatch, deleteDoc, increment
        };

        // Dispatch event when Firebase is ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: #f0fdf4; margin: 0; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .stamp-animation { animation: stamp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes stamp { 0% { transform: scale(3); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .correct-flash { animation: flashGreen 0.5s; }
        @keyframes flashGreen { 0%, 100% { background-color: white; } 50% { background-color: #bbf7d0; } }
        .wrong-flash { animation: flashRed 0.5s; }
        @keyframes flashRed { 0%, 100% { background-color: white; } 50% { background-color: #fecaca; } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCPziY4qZiRI0LbWXrSCnsOhJUxNwvdxxE",
            authDomain: "organic-chem-master-74df8.firebaseapp.com",
            projectId: "organic-chem-master-74df8",
            storageBucket: "organic-chem-master-74df8.firebasestorage.app",
            messagingSenderId: "729011758610",
            appId: "1:729011758610:web:50fbddf730d36a90969acb"
        };

        // --- Data ---
        const COMPOUNDS_RAW = [
            { id: 1, name: "„É°„Çø„É≥", url: "https://drive.google.com/uc?id=1qwuf3wdb9DWG1n6wwx_D3qTRjn3Ozt1S" },
            { id: 2, name: "„Ç®„Çø„É≥", url: "https://drive.google.com/uc?id=1CrOzeJ4pHTSDreMKtZeWKLdP6POBxS7d" },
            { id: 3, name: "„Éó„É≠„Éë„É≥", url: "https://drive.google.com/uc?id=1g3wFagtQJdkVIqgtU4Zzmhpy-F-0xGEH" },
            { id: 4, name: "„Éñ„Çø„É≥", url: "https://drive.google.com/uc?id=1GwZ2WI5EgpAev0fW497sDMdMIZQeWqhK" },
            { id: 5, name: "„Éö„É≥„Çø„É≥", url: "https://drive.google.com/uc?id=1G7-wExihdcCFunGU7hLcc_jHkG9xODYH" },
            { id: 6, name: "„Éò„Ç≠„Çµ„É≥", url: "https://drive.google.com/uc?id=1gYPQLybCXaHBVabLOIXvSuS2uMpBNE25" },
            { id: 7, name: "„Éò„Éó„Çø„É≥", url: "https://drive.google.com/uc?id=1vP4aOetzSTxuY8mOuMcXE_SCCl0a6s9S" },
            { id: 8, name: "„Ç™„ÇØ„Çø„É≥", url: "https://drive.google.com/uc?id=1ceqcVpHUDIl9l5pYE0qs5T5fNx4rG5vz" },
            { id: 9, name: "„Éé„Éä„É≥", url: "https://drive.google.com/uc?id=1yRa3bZWP4aQWTnYXva2ajI_GXKDnTYxj" },
            { id: 10, name: "„Éá„Ç´„É≥", url: "https://drive.google.com/uc?id=1F7_wGXPKV4oSHUShlhAT5sijTxxowW3m" },
            { id: 11, name: "2-„É°„ÉÅ„É´„Éó„É≠„Éë„É≥", url: "https://drive.google.com/uc?id=18oEhAyKLlBY9dQ3M5_AjTw8VKa5a_cjZ" },
            { id: 12, name: "2,2-„Ç∏„É°„ÉÅ„É´„Éó„É≠„Éë„É≥", url: "https://drive.google.com/uc?id=1kOHmza4LS48n3v75odFXdvf-rv5mfb0z" },
            { id: 13, name: "2-„É°„ÉÅ„É´„Éñ„Çø„É≥", url: "https://drive.google.com/uc?id=1S9bQgZdSX_lh4_CMkXMZU0_DdRGXImdi" },
            { id: 14, name: "„ÇØ„É≠„É≠„É°„Çø„É≥", url: "https://drive.google.com/uc?id=1nb7fZllNwzaMehukxofoQvrZgJoZsrIg" },
            { id: 15, name: "„Ç∑„ÇØ„É≠„Éó„É≠„Éë„É≥", url: "https://drive.google.com/uc?id=1X-JfZD8UX8X1A7Z8JYfog8ySPLHaIrfb" },
            { id: 16, name: "„Ç∑„ÇØ„É≠„Éñ„Çø„É≥", url: "https://drive.google.com/uc?id=1G2di0KGHHwb7XrrujmtCx2LnKtqR3GKh" },
            { id: 17, name: "„Ç∑„ÇØ„É≠„Éö„É≥„Çø„É≥", url: "https://drive.google.com/uc?id=1mujXix4X9rXHMuHvmSDhHbyIlNTugv6a" },
            { id: 18, name: "„Ç∑„ÇØ„É≠„Éò„Ç≠„Çµ„É≥", url: "https://drive.google.com/uc?id=1p9nsVX1Imr73OgdWf6-3WCxC66UidiQi" },
            { id: 19, name: "1,3-„Ç∏„Éñ„É≠„É¢„Éó„É≠„Éë„É≥", url: "https://drive.google.com/uc?id=1V14tJWEQqLjSmGm8QlSp_ln_HfgwwJju" },
            { id: 20, name: "„Ç®„ÉÅ„É¨„É≥", url: "https://drive.google.com/uc?id=1wRQCUZqXTDcxvfr-mxGY_SBmD2bh-2gj" },
            { id: 21, name: "„Éó„É≠„Éö„É≥", url: "https://drive.google.com/uc?id=1NEWWg-VwBzsPUJ2mdCwBVXTal7r-rnbz" },
            { id: 22, name: "1-„Éñ„ÉÜ„É≥", url: "https://drive.google.com/uc?id=1S-v3oD6zbcRE-TpF1jEyISQLi9aIrrFR" },
            { id: 23, name: "1-„Éö„É≥„ÉÜ„É≥", url: "https://drive.google.com/uc?id=1IgA0UmN8wvQckAyrkIMCwkZrHodzL80E" },
            { id: 24, name: "„Éù„É™„Ç®„ÉÅ„É¨„É≥", url: "https://drive.google.com/uc?id=1YcDY-GFAoX7qufa0slHtWbWjcR6mqYzi" },
            { id: 25, name: "1,2-„Ç∏„ÇØ„É≠„É≠„Ç®„Çø„É≥", url: "https://drive.google.com/uc?id=1nks_uca294VAITXzfBGxXjOK1INht9Un" },
            { id: 26, name: "Â°©Âåñ„Éì„Éã„É´", url: "https://drive.google.com/uc?id=14YA0CDzodiyBybgaXGxlKmdQ1A-AuFCB" },
            { id: 27, name: "„Éù„É™Â°©Âåñ„Éì„Éã„É´", url: "https://drive.google.com/uc?id=1UtJ86puivNGIpex6OvgwpMqMVWp-igkS" },
            { id: 28, name: "„Ç∑„ÇØ„É≠„Éò„Ç≠„Çª„É≥", url: "https://drive.google.com/uc?id=1dwbFMkOn1_oxQrOqs9eRa0t0cirVJu_k" },
            { id: 29, name: "1,2-„Ç∏„Éñ„É≠„É¢„Ç∑„ÇØ„É≠„Éò„Ç≠„Çµ„É≥", url: "https://drive.google.com/uc?id=1dYgIwT2xjSN9lkFrRo6_vhBztKZX5EgB" },
            { id: 30, name: "„Ç¢„Çª„ÉÅ„É¨„É≥", url: "https://drive.google.com/uc?id=16Vxtx6QRUNafLi6gJUWiiYacNdgqJVY4" },
            { id: 31, name: "„Éó„É≠„Éî„É≥", url: "https://drive.google.com/uc?id=1fOD_Q9hUaL3s3jFiz6zjnjXpxnprW_KC" },
            { id: 32, name: "1-„Éñ„ÉÅ„É≥", url: "https://drive.google.com/uc?id=1Ks4mgkY_atH0HfpAX5mfU1LF8_iIAlZJ" },
            { id: 33, name: "2-„Éñ„ÉÅ„É≥", url: "https://drive.google.com/uc?id=1hDy-mm3_QV8aSBMrqW9468DMsaFsTVMf" },
            { id: 34, name: "1,2-„Ç∏„Éñ„É≠„É¢„Ç®„ÉÅ„É¨„É≥", url: "https://drive.google.com/uc?id=1GpIi5c0qqENnbS5I-L9xL20eG8mCmas6" },
            { id: 35, name: "1,1,2,2-„ÉÜ„Éà„É©„Éñ„É≠„É¢„Ç®„Çø„É≥", url: "https://drive.google.com/uc?id=18p2hLqqmn7HD_fvoqsfSQUQibXsPSYsk" },
            { id: 36, name: "ÈÖ¢ÈÖ∏„Éì„Éã„É´", url: "https://drive.google.com/uc?id=1MCqTU1bxjop9Cx1N7DiZLYUQNUazgWgr" },
            { id: 37, name: "„Éì„Éã„É´„Ç¢„É´„Ç≥„Éº„É´", url: "https://drive.google.com/uc?id=17I2aAY0DaogMmdyz8RBB-xhGOEtNJ_2o" },
            { id: 38, name: "„É°„Çø„Éé„Éº„É´", url: "https://drive.google.com/uc?id=1MLRk9V36HeUz4ykQSluAOr7XKSt51OUw" },
            { id: 39, name: "„Ç®„Çø„Éé„Éº„É´", url: "https://drive.google.com/uc?id=17VYiJStifeQi-z5l3f-vCJPF2KqDXO7T" },
            { id: 40, name: "1-„Éó„É≠„Éë„Éé„Éº„É´", url: "https://drive.google.com/uc?id=1FHisQ7G4_5NDVKOLjd5XEC33bbePpR5c" },
            { id: 41, name: "2-„Éó„É≠„Éë„Éé„Éº„É´", url: "https://drive.google.com/uc?id=1af_8yBLA5W5jRzSiOhFNJ9kxWv46P0oY" },
            { id: 42, name: "1-„Éñ„Çø„Éé„Éº„É´", url: "https://drive.google.com/uc?id=1uOTbTvfnp_ku5v2aZg9sEqex-VnubXXP" },
            { id: 43, name: "2-„Éñ„Çø„Éé„Éº„É´", url: "https://drive.google.com/uc?id=1qpRtUvwn2jFER_b6FzTbNO379Lr5pBTJ" },
            { id: 44, name: "2-„É°„ÉÅ„É´-2-„Éó„É≠„Éë„Éé„Éº„É´", url: "https://drive.google.com/uc?id=1xc3eo0TcClPmZixn9CYsuwYTZ4PUGLGh" },
            { id: 45, name: "„Ç®„ÉÅ„É¨„É≥„Ç∞„É™„Ç≥„Éº„É´(1,2-„Ç®„Çø„É≥„Ç∏„Ç™„Éº„É´)", url: "https://drive.google.com/uc?id=1jrCSgMRlDQykc41WeeRkr4zu2iMxzPwz" },
            { id: 46, name: "„Ç∞„É™„Çª„É™„É≥(1,2,3-„Éó„É≠„Éë„É≥„Éà„É™„Ç™„Éº„É´)", url: "https://drive.google.com/uc?id=1-ncB_GUXGdBWBRZniHzLule8Xk8SLzgn" },
            { id: 47, name: "„Ç∏„É°„ÉÅ„É´„Ç®„Éº„ÉÜ„É´", url: "https://drive.google.com/uc?id=1a9FO6e0OUXb6K3B5ZYWAuBdgnc9RadeU" },
            { id: 48, name: "„Ç∏„Ç®„ÉÅ„É´„Ç®„Éº„ÉÜ„É´", url: "https://drive.google.com/uc?id=1oAflkadU9EOIhG8zoYQ4JgZ7mH8s2N6e" },
            { id: 49, name: "„Éõ„É´„É†„Ç¢„É´„Éá„Éí„Éâ", url: "https://drive.google.com/uc?id=1vlTBTgEduTZngEsoJjkwnjRHPJzyfJPs" },
            { id: 50, name: "„Ç¢„Çª„Éà„Ç¢„É´„Éá„Éí„Éâ", url: "https://drive.google.com/uc?id=1Ff-uoS4SnqS6I-Vz0bcKAguRVP6jaAB7" },
            { id: 51, name: "„Ç¢„Çª„Éà„É≥", url: "https://drive.google.com/uc?id=13dSmxVaIhnBIRuLJQvi_-BcY32fCqID5" },
            { id: 52, name: "„Ç∏„Ç®„ÉÅ„É´„Ç±„Éà„É≥", url: "https://drive.google.com/uc?id=1mtAlD4eKCGXVmgEF86tlrSIS9MqCbH0S" },
            { id: 53, name: "„Ç®„ÉÅ„É´„É°„ÉÅ„É´„Ç±„Éà„É≥", url: "https://drive.google.com/uc?id=1j8fQ9j_EGZ5FEv9IMgSIDrLaRbIAbaEh" },
            { id: 54, name: "„ÇÆÈÖ∏", url: "https://drive.google.com/uc?id=1pSYdqFdPEolimAhXq40f9DOg9IIhyS2M" },
            { id: 55, name: "ÈÖ¢ÈÖ∏", url: "https://drive.google.com/uc?id=1ol0tKW88zkow04y6j4Q9rxoO23xRCcik" },
            { id: 56, name: "„Éó„É≠„Éî„Ç™„É≥ÈÖ∏", url: "https://drive.google.com/uc?id=18wtdKAoZ2APZTUIZ73OR-6v1BA5jhZf8" },
            { id: 57, name: "„Ç∑„É•„Ç¶ÈÖ∏", url: "https://drive.google.com/uc?id=1uo6YMqjLTTuNiv157UeYJnCJqetoui0U" },
            { id: 58, name: "„Éï„Éû„É´ÈÖ∏", url: "https://drive.google.com/uc?id=1n-PtMeWqPcqWm-VIZeKPX73Fr_7-kKsP" },
            { id: 59, name: "„Éû„É¨„Ç§„É≥ÈÖ∏", url: "https://drive.google.com/uc?id=1em_wSlTI1Yqlb0v2_6CsHbsoubcoPsfK" },
            { id: 60, name: "„ÇÆÈÖ∏„É°„ÉÅ„É´", url: "https://drive.google.com/uc?id=1VDsxFdP2H0gENGLVaQKNI82J_TPW999t" },
            { id: 61, name: "„ÇÆÈÖ∏„Ç®„ÉÅ„É´", url: "https://drive.google.com/uc?id=13XA16_FcKMwkAsIKZLNK66t0Gtncan5b" },
            { id: 62, name: "ÈÖ¢ÈÖ∏„É°„ÉÅ„É´", url: "https://drive.google.com/uc?id=1lLEnHVhuPbhBTy_LSsNmwq-M63GK4vX6" },
            { id: 63, name: "ÈÖ¢ÈÖ∏„Ç®„ÉÅ„É´", url: "https://drive.google.com/uc?id=1wtj8VfQClmn3oSLXSFbxJ80mVohAcpDY" },
            { id: 64, name: "„Éã„Éà„É≠„Ç∞„É™„Çª„É™„É≥", url: "https://drive.google.com/uc?id=1ucWCMs6PLxxHv1gHf0jay4jQ19JV1JJp" },
            { id: 65, name: "ÁÑ°Ê∞¥ÈÖ¢ÈÖ∏", url: "https://drive.google.com/uc?id=1vwwmjs8pot9IgWliT9Z_9E3Iq0qT-Q6c" },
            { id: 66, name: "ÁÑ°Ê∞¥„Éû„É¨„Ç§„É≥ÈÖ∏", url: "https://drive.google.com/uc?id=1Y77s0YNIcO0A9VlgiE12Mz09WmkYIeph" },
            { id: 67, name: "„Çπ„ÉÜ„Ç¢„É™„É≥ÈÖ∏", url: "https://drive.google.com/uc?id=1VpuN8v9dWYNp6SBFjXQJV2lz3P74HuPp" },
            { id: 68, name: "„Ç™„É¨„Ç§„É≥ÈÖ∏", url: "https://drive.google.com/uc?id=1AorSLuRzZVukm3tu9xN3ifFg3jlrNkxL" },
            { id: 69, name: "„É™„Éé„Éº„É´ÈÖ∏", url: "https://drive.google.com/uc?id=1ZQ-tGPuv-YxAcmBzmVe4YBuF_DQUCejW" },
            { id: 70, name: "„É™„Éé„É¨„É≥ÈÖ∏", url: "https://drive.google.com/uc?id=1fDP2ZMIt-Nfy9-c6YkScUnahe87FzB6C" },
            { id: 71, name: "„Éë„É´„Éü„ÉÅ„É≥ÈÖ∏", url: "https://drive.google.com/uc?id=1-PC9yIEf9xKySuteoMBHyMlwYKIjlmb-" },
            { id: 72, name: "„Éà„É´„Ç®„É≥", url: "https://drive.google.com/uc?id=1chwCVv0x0nx3Ljs2Us9C6do2z4s6qc_-" },
            { id: 73, name: "o-„Ç≠„Ç∑„É¨„É≥", url: "https://drive.google.com/uc?id=1vvSIPoASaLA1YnhHKKhqm4NpyewSEWyI" },
            { id: 74, name: "m-„Ç≠„Ç∑„É¨„É≥", url: "https://drive.google.com/uc?id=1xBbpXrglhh1jFwxhcf5jcLn2GKKf1bw9" },
            { id: 75, name: "p-„Ç≠„Ç∑„É¨„É≥", url: "https://drive.google.com/uc?id=1YbprW360oG3VX9bjNl1n6t8eJ6BtFX43" },
            { id: 76, name: "„Éä„Éï„Çø„É¨„É≥", url: "https://drive.google.com/uc?id=1KmhaqmQqwjj62u5I2Bces9WCDDZW5JnR" },
            { id: 77, name: "„Ç®„ÉÅ„É´„Éô„É≥„Çº„É≥", url: "https://drive.google.com/uc?id=1dxxG5zkCEuhCVcC5Iq9neiMOHK10HrxJ" },
            { id: 78, name: "„Çπ„ÉÅ„É¨„É≥", url: "https://drive.google.com/uc?id=1zkB1-129ywkhlhCfCqPCkP01jpI3Jkts" },
            { id: 79, name: "„Ç¢„É≥„Éà„É©„Çª„É≥", url: "https://drive.google.com/uc?id=1bLmAsLWpBX1bU3HDLi2SPP3PkdRbaZL3" },
            { id: 80, name: "„Éã„Éà„É≠„Éô„É≥„Çº„É≥", url: "https://drive.google.com/uc?id=1299ipfDqC7IsoWjk3ZiiY6tkyJV3FjVF" },
            { id: 81, name: "„Éô„É≥„Çº„É≥„Çπ„É´„Éõ„É≥ÈÖ∏", url: "https://drive.google.com/uc?id=1dymAxReQn18wHoxFjxDKev6KevOxikk2" },
            { id: 82, name: "„Éô„É≥„Çº„É≥„Çπ„É´„Éõ„É≥ÈÖ∏„Éä„Éà„É™„Ç¶„É†", url: "https://drive.google.com/uc?id=14Io2aW8KqkzSePTbDBzda1qbSHAd8FvP" },
            { id: 83, name: "„ÇØ„É≠„É≠„Éô„É≥„Çº„É≥", url: "https://drive.google.com/uc?id=1hJTiqbYOQ6eXjxzpuJIAiDXAlLBLi9ev" },
            { id: 84, name: "„Éñ„É≠„É¢„Éô„É≥„Çº„É≥", url: "https://drive.google.com/uc?id=1WranYLAIfl62BrtCu53ZjDwLNjbe0YXF" },
            { id: 85, name: "„Éï„Çß„Éé„Éº„É´", url: "https://drive.google.com/uc?id=1KWv5mdo3MqNDhAocDnimV_28zHaHLO4-" },
            { id: 86, name: "o-„ÇØ„É¨„Çæ„Éº„É´", url: "https://drive.google.com/uc?id=1E9CXpDC8Fama-B_cEw-IyIBU99cR8HyM" },
            { id: 87, name: "m-„ÇØ„É¨„Çæ„Éº„É´", url: "https://drive.google.com/uc?id=1SbkDLX3iQ1v5BzRETv9-r3T74TtdwOhP" },
            { id: 88, name: "p-„ÇØ„É¨„Çæ„Éº„É´", url: "https://drive.google.com/uc?id=1Vo4ZLWuvX7KJJ6M4in5yK3LhdRRvvg7y" },
            { id: 89, name: "2-„Éä„Éï„Éà„Éº„É´", url: "https://drive.google.com/uc?id=1lOIv8i5j7hUPUanbHYppuFAgV2c3E8TW" },
            { id: 90, name: "1-„Éä„Éï„Éà„Éº„É´", url: "https://drive.google.com/uc?id=16pBQ1mbe6DDQGqRYn6oB8qXfcNOQfMzH" },
            { id: 91, name: "„Çµ„É™„ÉÅ„É´ÈÖ∏", url: "https://drive.google.com/uc?id=1pK4QTYn-izGgWNnKykwUdAXq4Ui-q9m7" },
            { id: 92, name: "„Éä„Éà„É™„Ç¶„É†„Éï„Çß„Éé„Ç≠„Ç∑„Éâ", url: "https://drive.google.com/uc?id=1stULQIdzgq3-dtGXJTRxqx_zesQDqNlJ" },
            { id: 93, name: "2,4,6-„Éà„É™„Éñ„É≠„É¢„Éï„Çß„Éé„Éº„É´", url: "https://drive.google.com/uc?id=1pI5k4uI28IDgWXVi7B5N7dEW08IumdO5" },
            { id: 94, name: "„Éî„ÇØ„É™„É≥ÈÖ∏(2,4,6-„Éà„É™„Éã„Éà„É≠„Éï„Çß„Éé„Éº„É´)", url: "https://drive.google.com/uc?id=1XaGFiK5PENRVqBlaC69e3G3e_OMnRAR7" },
            { id: 95, name: "ÂÆâÊÅØÈ¶ôÈÖ∏", url: "https://drive.google.com/uc?id=1gMGVSqKspWzDedA0SXghz2c3inyg9djj" },
            { id: 96, name: "„Éï„Çø„É´ÈÖ∏", url: "https://drive.google.com/uc?id=1N_rWbSkQyej74oE8op46m--FhDZMqQb9" },
            { id: 97, name: "„ÉÜ„É¨„Éï„Çø„É´ÈÖ∏", url: "https://drive.google.com/uc?id=1GAvORrAFlGV5oYQmt153C6Y4-QpEexAq" },
            { id: 98, name: "„Éô„É≥„Ç∫„Ç¢„É´„Éá„Éí„Éâ", url: "https://drive.google.com/uc?id=1Uk5Ql8uUKKbf1gJzhN9coKLJBJq3anN6" },
            { id: 99, name: "ÁÑ°Ê∞¥„Éï„Çø„É´ÈÖ∏", url: "https://drive.google.com/uc?id=1z7IXQ5IFp5TkVQgSIr6o5r5_S_W-Ozp9" },
            { id: 100, name: "„Ç¢„Çª„ÉÅ„É´„Çµ„É™„ÉÅ„É´ÈÖ∏", url: "https://drive.google.com/uc?id=14K4Krkb2Dqf3DAm_-z4yXX4d4kWD0kG5" },
            { id: 101, name: "„Çµ„É™„ÉÅ„É´ÈÖ∏„É°„ÉÅ„É´", url: "https://drive.google.com/uc?id=1-int_XRJBVsU0vIgZmpnXQY4P5N_osr9" },
            { id: 102, name: "„Ç¢„Éã„É™„É≥", url: "https://drive.google.com/uc?id=1GePbtEc1a1QjBKVFjeh41ABzw9lMjaKM" },
            { id: 103, name: "„Ç¢„Éã„É™„É≥Â°©ÈÖ∏Â°©", url: "https://drive.google.com/uc?id=1_pwuRWh5fZ2MLCivvrEClhYVbj3RiI2A" },
            { id: 104, name: "„Ç¢„Çª„Éà„Ç¢„Éã„É™„Éâ", url: "https://drive.google.com/uc?id=1cbUIx6RF5glFD2vv9tQdl_-EYuHRiThL" },
            { id: 105, name: "Â°©Âåñ„Éô„É≥„Çº„É≥„Ç∏„Ç¢„Çæ„Éã„Ç¶„É†", url: "https://drive.google.com/uc?id=1ndAdSMZ-2PW7cOepP4xR6od3kqa9cY0X" },
            { id: 106, name: "p-„Éí„Éâ„É≠„Ç≠„Ç∑„Ç¢„Çæ„Éô„É≥„Çº„É≥", url: "https://drive.google.com/uc?id=1mg5ToUTzj5HwpmaOTnYuZu55CY74zSLU" },
            { id: 107, name: "1-„Éï„Çß„Éã„É´„Ç¢„Çæ-2-„Éä„Éï„Éà„Éº„É´", url: "https://drive.google.com/uc?id=1dSkKW-QhPlbZ1w9W0-O8nLo7RHcg6wDw" },
            { id: 108, name: "2,4,6-„Éà„É™„Éã„Éà„É≠„Éà„É´„Ç®„É≥", url: "https://drive.google.com/uc?id=1VJ-CfAN2uishpm9wTZpCdwMsT-MST4h7" },
            { id: 109, name: "„ÇØ„É°„É≥", url: "https://drive.google.com/uc?id=1fHsWsXlPIvd3x3bbxm86IbWoJY-KtiZb" },
            { id: 110, name: "„ÇØ„É°„É≥„Éí„Éâ„É≠„Éö„É´„Ç™„Ç≠„Ç∑„Éâ", url: "https://drive.google.com/uc?id=1zzr3qIiIpeNwJMZgrG-RuQCQYu7s8d2b" },
            { id: 111, name: "„Éô„É≥„Çº„É≥", url: "https://drive.google.com/uc?id=1JpKeyNXgIv0RXc2VntrWJCeoem-DatqZ" }
        ];

        // --- Helper to convert Google Drive URL to a safe direct link ---
        // This format (lh3.googleusercontent.com/d/...) is generally more reliable for IMG tags
        const getDriveImageUrl = (url) => {
            if (!url) return 'https://placehold.co/400?text=No+Image';
            // Extract ID from https://drive.google.com/uc?id=...
            const match = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                // Use lh3.googleusercontent.com/d/ format which is more robust for direct embedding
                return `https://lh3.googleusercontent.com/d/${match[1]}`;
            }
            return url;
        };

        // Convert RAW data to usable data with fixed URLs
        const COMPOUNDS = COMPOUNDS_RAW.map(c => ({
            ...c,
            url: getDriveImageUrl(c.url)
        }));

        // --- Firebase Initialization Helper (Wait for SDK) ---
        // This function ensures Firebase and React are ready before starting the app
        const waitForFirebase = () => {
            return new Promise(resolve => {
                if (window.firebaseModules && window.firebaseModules.initializeApp) {
                    resolve(window.firebaseModules);
                } else {
                    window.addEventListener('firebase-ready', () => {
                        resolve(window.firebaseModules);
                    });
                }
            });
        };

        // --- Utils ---
        const RANKS = [
            { threshold: 0, name: "„Éì„Éº„Ç´„ÉºÊ¥ó„ÅÑ", color: "bg-gray-400" },
            { threshold: 1, name: "Ë¶ãÁøí„ÅÑÂ≠¶Áîü", color: "bg-blue-400" },
            { threshold: 5, name: "ÂÆüÈ®ìÂä©Êâã", color: "bg-green-400" },
            { threshold: 10, name: "Á†îÁ©∂Âì°", color: "bg-teal-500" },
            { threshold: 20, name: "‰∏ª‰ªªÁ†îÁ©∂Âì°", color: "bg-indigo-500" },
            { threshold: 40, name: "ÂçöÂ£´", color: "bg-purple-500" },
            { threshold: 70, name: "ÊïôÊéà", color: "bg-pink-500" },
            { threshold: 100, name: "ÊúâÊ©üÂåñÂ≠¶„Éû„Çπ„Çø„Éº", color: "bg-yellow-500" }
        ];

        const getRank = (stamps) => RANKS.slice().reverse().find(r => stamps >= r.threshold) || RANKS[0];

        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        };

        // --- Components ---

        const Loading = () => (
            <div className="flex justify-center items-center h-screen bg-green-50">
                <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-600"></div>
            </div>
        );

        // --- Question Card Component ---
        const QuestionCard = ({ question, currentIdx, total, timeLeft, onAnswer }) => {
            const [selectedId, setSelectedId] = useState(null);

            const handleAnswer = (choice) => {
                if (selectedId) return; // Prevent double click
                setSelectedId(choice.id);
                
                const isCorrect = choice.id === question.correct.id;
                onAnswer(isCorrect, choice);
            };

            const selectedChoice = question.choices.find(c => c.id === selectedId);
            const isCorrectSelected = selectedChoice && selectedChoice.id === question.correct.id;

            return (
                <div className={`max-w-2xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden ${selectedId ? (isCorrectSelected ? 'correct-flash' : 'wrong-flash') : ''}`}>
                    <div className="bg-gray-100 p-4 flex justify-between items-center">
                        <div className="font-bold text-gray-600">Q.{currentIdx + 1} / {total}</div>
                        <div className={`font-mono text-xl font-bold ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-gray-700'}`}>
                            ‚è± {timeLeft}s
                        </div>
                    </div>

                    <div className="p-6 text-center">
                        {question.type === 'name-to-struct' ? (
                            <div className="mb-6">
                                <h2 className="text-sm text-gray-500 mb-2">„Åì„ÅÆÊßãÈÄ†Âºè„ÅÆÂêçÁß∞„ÅØÔºü</h2>
                                <div className="flex justify-center">
                                    <div className="bg-white border-2 border-gray-200 rounded-xl p-4 w-64 h-48 flex items-center justify-center overflow-hidden">
                                         <img 
                                            key={question.correct.url}
                                            src={question.correct.url} 
                                            alt="structure" 
                                            className="max-w-full max-h-full object-contain" 
                                            referrerPolicy="no-referrer"
                                            onError={(e)=>{e.target.src='https://placehold.co/200?text=No+Image'}} 
                                        />
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="mb-6">
                                <h2 className="text-sm text-gray-500 mb-2">Ê¨°„ÅÆÂåñÂêàÁâ©„ÅÆÊßãÈÄ†Âºè„ÅØÔºü</h2>
                                <h1 className="text-3xl font-bold text-gray-800 my-8">{question.correct.name}</h1>
                            </div>
                        )}

                        <div className="grid grid-cols-2 gap-4">
                            {question.choices.map((choice) => (
                                <button
                                    key={choice.id}
                                    onClick={() => handleAnswer(choice)}
                                    disabled={selectedId !== null}
                                    className={`p-4 rounded-xl border-2 transition transform hover:scale-105 active:scale-95 flex items-center justify-center min-h-[80px]
                                        ${selectedId === null ? 'border-gray-200 hover:border-blue-400 hover:bg-blue-50' : ''}
                                        ${selectedId !== null && choice.id === question.correct.id ? 'bg-green-100 border-green-500 ring-2 ring-green-300' : ''}
                                        ${selectedId === choice.id && choice.id !== question.correct.id ? 'bg-red-100 border-red-500 opacity-80' : ''}
                                        ${selectedId !== null && selectedId !== choice.id && choice.id !== question.correct.id ? 'opacity-40' : ''}
                                    `}
                                >
                                    {question.type === 'name-to-struct' ? (
                                        <span className="font-bold text-lg">{choice.name}</span>
                                    ) : (
                                        <div className="w-full h-24 flex items-center justify-center overflow-hidden">
                                            <img 
                                                key={choice.url}
                                                src={choice.url} 
                                                alt="choice" 
                                                className="max-w-full max-h-full object-contain" 
                                                referrerPolicy="no-referrer"
                                                onError={(e)=>{e.target.src='https://placehold.co/100?text=?'}} 
                                            />
                                        </div>
                                    )}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Active Quiz Container ---
        const ActiveQuiz = ({ questions, timeLimit, onFinish }) => {
            const [currentIdx, setCurrentIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(timeLimit);
            const [answers, setAnswers] = useState([]);
            const [startTime] = useState(Date.now());
            const timerRef = useRef(null);

            useEffect(() => {
                timerRef.current = setInterval(() => {
                    setTimeLeft((prev) => {
                        if (prev <= 1) {
                            clearInterval(timerRef.current);
                            handleFinishQuiz(score, answers, 0); // Time over
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timerRef.current);
            }, [score, answers]);

            const handleFinishQuiz = (finalScore, finalAnswers, finalTimeLeft) => {
                const timeTaken = timeLimit - (finalTimeLeft > 0 ? finalTimeLeft : 0);
                onFinish({ score: finalScore, timeTaken: (Date.now() - startTime) / 1000, answers: finalAnswers });
            };

            const handleAnswer = (isCorrect, choice) => {
                const newScore = isCorrect ? score + 1 : score;
                const newAnswers = [...answers, isCorrect];
                setScore(newScore);
                setAnswers(newAnswers);

                setTimeout(() => {
                    if (currentIdx + 1 < questions.length) {
                        setCurrentIdx(prev => prev + 1);
                    } else {
                        clearInterval(timerRef.current);
                        handleFinishQuiz(newScore, newAnswers, timeLeft);
                    }
                }, 600);
            };

            return (
                <QuestionCard 
                    key={currentIdx}
                    question={questions[currentIdx]}
                    currentIdx={currentIdx}
                    total={questions.length}
                    timeLeft={timeLeft}
                    onAnswer={handleAnswer}
                />
            );
        };

        // --- Game Logic ---
        const generateQuestions = (count) => {
            const questions = [];
            const all = shuffleArray([...COMPOUNDS]);
            
            for (let i = 0; i < count; i++) {
                const correct = all[i];
                const others = shuffleArray(COMPOUNDS.filter(c => c.id !== correct.id)).slice(0, 3);
                const choices = shuffleArray([correct, ...others]);
                
                questions.push({
                    correct,
                    choices,
                    type: Math.random() > 0.5 ? 'name-to-struct' : 'struct-to-name'
                });
            }
            return questions;
        };

        // --- Main App Component (Wait for Firebase Init) ---
        const App = () => {
            const [fb, setFb] = useState(null); // Firebase modules
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState("dashboard"); // dashboard, drill, test, teacher
            const [activeSession, setActiveSession] = useState(null);
            
            // Other state for teacher dashboard
            const [teacherTab, setTeacherTab] = useState('tests');
            const [sessions, setSessions] = useState([]);
            const [batchInput, setBatchInput] = useState("");

            // Initialize Firebase
            useEffect(() => {
                waitForFirebase().then((modules) => {
                    // Initialize App only once
                    try {
                        const app = modules.initializeApp(firebaseConfig);
                        const auth = modules.getAuth(app);
                        const db = modules.getFirestore(app);
                        setFb({ auth, db, modules });
                        
                        // Hide loading screen
                        const loader = document.getElementById('loading-screen');
                        if (loader) loader.style.display = 'none';
                        
                        // Auth Listener
                        modules.onAuthStateChanged(auth, async (currentUser) => {
                            setUser(currentUser);
                            if (currentUser) {
                                const userRef = modules.doc(db, "users", currentUser.uid);
                                const userSnap = await modules.getDoc(userRef);
                                
                                if (userSnap.exists()) {
                                    setUserData(userSnap.data());
                                } else {
                                    // Check pre-registration
                                    if (currentUser.email) {
                                        const preRegRef = modules.doc(db, "pre_registrations", currentUser.email);
                                        const preRegSnap = await modules.getDoc(preRegRef);
                                        
                                        if (preRegSnap.exists()) {
                                            const preData = preRegSnap.data();
                                            const newData = {
                                                uid: currentUser.uid,
                                                email: currentUser.email,
                                                name: preData.name,
                                                classId: preData.classId,
                                                studentNumber: preData.studentNumber || "",
                                                role: 'student',
                                                stamps: 0,
                                                drillStats: { attempts: 0, passes: 0 },
                                                createdAt: modules.serverTimestamp()
                                            };
                                            await modules.setDoc(userRef, newData);
                                            setUserData(newData);
                                        } else {
                                            setUserData(null);
                                        }
                                    } else {
                                        setUserData(null);
                                    }
                                }
                            } else {
                                setUserData(null);
                            }
                            setLoading(false);
                        });
                    } catch (e) {
                        console.error("Firebase init error", e);
                        // If already initialized, just get instances
                        // This part is tricky with modular SDK, usually initializeApp returns the existing app if called again? 
                        // Actually in modular SDK, we usually hold the app instance. 
                        // But since we are inside useEffect with empty dep, it runs once.
                    }
                });
            }, []);

            // Test Session Listener
            useEffect(() => {
                if (!fb || !userData || userData.role !== 'student') return;
                
                const q = fb.modules.query(
                    fb.modules.collection(fb.db, "test_sessions"),
                    fb.modules.where("status", "in", ["active", "standby"]),
                    fb.modules.where("targetClasses", "array-contains", userData.classId)
                );

                const unsubscribe = fb.modules.onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const session = snapshot.docs[0].data();
                        session.id = snapshot.docs[0].id;
                        setActiveSession(session);
                    } else {
                        setActiveSession(null);
                    }
                });
                return () => unsubscribe();
            }, [fb, userData]);

            // Teacher Dashboard Logic (Sessions Loader)
            useEffect(() => {
                if (!fb || !userData || userData.role !== 'teacher') return;
                const q = fb.modules.query(
                    fb.modules.collection(fb.db, "test_sessions"),
                    fb.modules.orderBy("startTime", "desc")
                );
                const unsub = fb.modules.onSnapshot(q, (snap) => {
                    setSessions(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsub();
            }, [fb, userData, teacherTab]);


            // --- Actions ---

            const handleLogout = () => {
                if (fb) {
                    fb.modules.signOut(fb.auth);
                    setView("dashboard");
                }
            };

            const handleRegister = async (name, classId, studentNumber, isTeacher) => {
                if (!fb || !user) return;
                const role = isTeacher ? 'teacher' : 'student';
                const data = {
                    uid: user.uid,
                    email: user.email,
                    name,
                    classId,
                    studentNumber: studentNumber || "",
                    role,
                    stamps: 0,
                    drillStats: { attempts: 0, passes: 0 },
                    createdAt: fb.modules.serverTimestamp()
                };
                await fb.modules.setDoc(fb.modules.doc(fb.db, "users", user.uid), data);
                setUserData(data);
            };

            // Drill
            const [drillQuestions, setDrillQuestions] = useState([]);
            const [drillResult, setDrillResult] = useState(null);

            const startDrill = () => {
                const qs = generateQuestions(10);
                setDrillQuestions(qs);
                setView('drill_playing');
            };

            const finishDrill = async (res) => {
                const passed = res.score >= 8;
                setDrillResult({ ...res, passed });
                setView('drill_result');
                
                if (fb && userData) {
                    const userRef = fb.modules.doc(fb.db, "users", user.uid);
                    const updates = {
                        "drillStats.attempts": fb.modules.increment(1),
                        "drillStats.passes": passed ? fb.modules.increment(1) : fb.modules.increment(0)
                    };
                    if (passed) updates.stamps = fb.modules.increment(1);
                    await fb.modules.updateDoc(userRef, updates);
                }
            };

            // Test
            const [testQuestions, setTestQuestions] = useState([]);
            const [testRank, setTestRank] = useState(null);

            const startTest = () => {
                if (!activeSession) return;
                // Generate questions based on session data logic (here simplified to regenerate for robustness or should follow server instructions?)
                // The requirement says "everyone gets same questions".
                // In a real app, questions should be fetched from session.questionSet.
                // Reconstruct questions from IDs in session.questionSet
                if (activeSession.questionSet) {
                    const sessionQs = activeSession.questionSet.map(qData => {
                        const correct = COMPOUNDS.find(c => c.id === qData.correctId);
                        const choices = qData.choiceIds.map(id => COMPOUNDS.find(c => c.id === id));
                        return { correct, choices, type: qData.type };
                    });
                    setTestQuestions(sessionQs);
                    setView('test_playing');
                }
            };

            const finishTest = async (res) => {
                if (!fb || !activeSession) return;
                setView('test_result');
                await fb.modules.setDoc(fb.modules.doc(fb.db, "test_results", `${activeSession.id}_${user.uid}`), {
                    sessionId: activeSession.id,
                    uid: user.uid,
                    name: userData.name,
                    classId: userData.classId,
                    studentNumber: userData.studentNumber || "",
                    score: res.score,
                    timeTaken: res.timeTaken,
                    timestamp: fb.modules.serverTimestamp()
                });
                
                const q = fb.modules.query(
                    fb.modules.collection(fb.db, "test_results"), 
                    fb.modules.where("sessionId", "==", activeSession.id)
                );
                fb.modules.onSnapshot(q, (snap) => {
                    const results = snap.docs.map(d => d.data());
                    results.sort((a, b) => b.score - a.score || a.timeTaken - b.timeTaken);
                    setTestRank(results.findIndex(r => r.uid === user.uid) + 1);
                });
            };

            // Teacher Actions
            const createSession = async () => {
                const name = prompt("„ÉÜ„Çπ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æãÔºö1Â≠¶Êúü‰∏≠Èñì„ÉÜ„Çπ„ÉàÔºâ");
                if (!name) return;
                const qs = generateQuestions(10).map(q => ({
                    correctId: q.correct.id,
                    choiceIds: q.choices.map(c => c.id),
                    type: q.type
                }));
                await fb.modules.addDoc(fb.modules.collection(fb.db, "test_sessions"), {
                    name,
                    targetClasses: ["3-A", "3-B", "3-C", "3-D", "3-E"],
                    status: 'standby',
                    startTime: fb.modules.serverTimestamp(),
                    questionSet: qs
                });
            };

            const toggleStatus = async (session, newStatus) => {
                await fb.modules.updateDoc(fb.modules.doc(fb.db, "test_sessions", session.id), { status: newStatus });
            };

            const handleBatchRegister = async () => {
                const lines = batchInput.trim().split('\n');
                const batch = fb.modules.writeBatch(fb.db);
                let count = 0;
                try {
                    for (const line of lines) {
                        const [email, name, classId, studentNumber] = line.split(',').map(s => s.trim());
                        if (email && name && classId) {
                            const ref = fb.modules.doc(fb.db, "pre_registrations", email);
                            batch.set(ref, { name, classId, studentNumber: studentNumber || "", email });
                            count++;
                        }
                    }
                    await batch.commit();
                    alert(`${count}‰ª∂„ÅÆÁîüÂæí„Éá„Éº„Çø„Çí‰∏ÄÊã¨ÁôªÈå≤„Åó„Åæ„Åó„Åü„ÄÇ`);
                    setBatchInput("");
                } catch (e) {
                    alert("ÁôªÈå≤„Ç®„É©„Éº: " + e.message);
                }
            };

            const downloadCSV = async () => {
                // Implementation similar to previous logic
                const userSnap = await fb.modules.getDocs(fb.modules.collection(fb.db, "users"));
                let users = userSnap.docs.map(d => d.data()).filter(u => u.role === 'student');
                
                users.sort((a, b) => {
                    if (a.classId !== b.classId) return a.classId.localeCompare(b.classId);
                    return (parseInt(a.studentNumber) || 0) - (parseInt(b.studentNumber) || 0);
                });

                const resultSnap = await fb.modules.getDocs(fb.modules.collection(fb.db, "test_results"));
                const results = resultSnap.docs.map(d => d.data());
                const sessionSnap = await fb.modules.getDocs(fb.modules.collection(fb.db, "test_sessions"));
                const sessionList = sessionSnap.docs.map(d => ({id: d.id, name: d.data().name}));

                let csv = "„ÇØ„É©„Çπ,Âá∫Â∏≠Áï™Âè∑,Ê∞èÂêç";
                sessionList.forEach(s => csv += `,${s.name}`);
                csv += ",„Çπ„Çø„É≥„ÉóÊï∞,ÊºîÁøíÂõûÊï∞,ÊºîÁøíÂêàÊ†ºÊï∞,,„ÉÜ„Çπ„ÉàÂπ≥Âùá,ÊºîÁøíÂêàÊ†ºÁéá\n";

                users.forEach(u => {
                    let line = `${u.classId},${u.studentNumber || ""},${u.name}`;
                    let totalScore = 0;
                    let testCount = 0;
                    sessionList.forEach(s => {
                        const res = results.find(r => r.uid === u.uid && r.sessionId === s.id);
                        if (res) {
                            line += `,${res.score}`;
                            totalScore += res.score;
                            testCount++;
                        } else {
                            line += ",-";
                        }
                    });
                    // Simple stats
                    const drillRate = u.drillStats?.attempts ? ((u.drillStats.passes / u.drillStats.attempts) * 100).toFixed(1) : 0;
                    const testAvg = testCount ? (totalScore / testCount).toFixed(1) : 0;
                    line += `,${u.stamps},${u.drillStats?.attempts || 0},${u.drillStats?.passes || 0},,${testAvg},${drillRate}%`;
                    csv += line + "\n";
                });

                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `organic_chem_data.csv`);
                link.click();
            };

            const clearStudents = async () => {
                if(!confirm("Êú¨ÂΩì„Å´ÂÖ®ÁîüÂæí„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
                const snap = await fb.modules.getDocs(fb.modules.collection(fb.db, "users"));
                const batch = fb.modules.writeBatch(fb.db);
                let count = 0;
                snap.forEach(d => {
                    if (d.data().role === 'student') { batch.delete(d.ref); count++; }
                });
                await batch.commit();
                alert(`${count}‰ª∂ÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`);
            };


            // --- Render Logic ---

            if (!fb) return null; // Waiting for Firebase (loading screen handles visual)
            
            if (loading) return null; // Waiting for Auth

            // Login Screen
            if (!user) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-b from-green-50 to-green-100 p-4">
                        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center">
                            <div className="text-6xl mb-4">‚öóÔ∏è</div>
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">Organic Chem Master</h1>
                            <div className="space-y-3 mt-8">
                                <button onClick={() => fb.modules.signInWithPopup(fb.auth, new fb.modules.GoogleAuthProvider()).catch(e => alert(e.message))} className="w-full bg-white border border-gray-300 font-bold py-3 rounded-xl hover:bg-gray-50">
                                    Google„Åß„É≠„Ç∞„Ç§„É≥
                                </button>
                                <button onClick={() => fb.modules.signInAnonymously(fb.auth).catch(e => alert(e.message))} className="w-full bg-gray-600 text-white font-bold py-3 rounded-xl hover:bg-gray-700">
                                    „Ç≤„Çπ„Éà„Å®„Åó„Å¶ÈñãÂßã
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Registration
            if (!userData) {
                return <RegistrationScreen onRegister={handleRegister} />;
            }

            // Game Views
            if (view === 'drill_playing') {
                return <ActiveQuiz questions={drillQuestions} timeLimit={60} onFinish={finishDrill} />;
            }
            
            if (view === 'drill_result') {
                return (
                    <div className="min-h-screen bg-green-50 p-4 flex items-center justify-center">
                        <div className="bg-white p-8 rounded-3xl shadow-xl text-center max-w-md w-full fade-in">
                            <div className="text-6xl mb-4">{drillResult.passed ? 'üíÆ' : 'üí™'}</div>
                            <h2 className="text-2xl font-bold mb-4">{drillResult.passed ? 'ÂêàÊ†ºÔºÅ' : 'ÊÆãÂøµ...'}</h2>
                            <div className="text-4xl font-bold mb-8">{drillResult.score} / 10ÁÇπ</div>
                            <button onClick={() => setView('dashboard')} className="w-full bg-gray-800 text-white font-bold py-3 rounded-xl">„É°„Éã„É•„Éº„Å´Êàª„Çã</button>
                        </div>
                    </div>
                );
            }

            if (view === 'test_playing') {
                return <ActiveQuiz questions={testQuestions} timeLimit={60} onFinish={finishTest} />;
            }

            if (view === 'test_result') {
                return (
                    <div className="min-h-screen bg-indigo-50 p-4 flex items-center justify-center">
                        <div className="bg-white p-8 rounded-3xl shadow-xl text-center max-w-md w-full fade-in">
                            <h2 className="text-2xl font-bold mb-4">„ÉÜ„Çπ„ÉàÁµÇ‰∫ÜÔºÅ</h2>
                            {testRank ? <div className="text-5xl font-bold text-indigo-600 mb-8">{testRank}‰Ωç</div> : <div className="animate-pulse mb-8">ÈõÜË®à‰∏≠...</div>}
                            <button onClick={() => setView('dashboard')} className="w-full bg-gray-800 text-white font-bold py-3 rounded-xl">Êàª„Çã</button>
                        </div>
                    </div>
                );
            }

            if (view === 'teacher' && userData.role === 'teacher') {
                return (
                    <div className="min-h-screen bg-purple-50 p-4">
                        <header className="flex justify-between items-center bg-white p-4 rounded-xl shadow mb-6 max-w-5xl mx-auto">
                            <h1 className="font-bold text-purple-800">ÊïôÂì°ÁÆ°ÁêÜÁîªÈù¢</h1>
                            <button onClick={() => setView('dashboard')} className="text-gray-500">Êàª„Çã</button>
                        </header>
                        <div className="max-w-5xl mx-auto">
                            <div className="flex space-x-2 mb-6 overflow-x-auto">
                                {['tests', 'data', 'batch', 'students'].map(t => (
                                    <button key={t} onClick={() => setTeacherTab(t)} className={`px-4 py-2 rounded-lg font-bold capitalize whitespace-nowrap ${teacherTab === t ? 'bg-purple-600 text-white' : 'bg-white text-purple-600'}`}>
                                        {t === 'tests' ? '„ÉÜ„Çπ„ÉàÂÆüÊñΩ' : t === 'data' ? '„Éá„Éº„ÇøÂá∫Âäõ' : t === 'batch' ? '‰∏ÄÊã¨ÁôªÈå≤' : 'ÁîüÂæíÂâäÈô§'}
                                    </button>
                                ))}
                            </div>
                            
                            {teacherTab === 'tests' && (
                                <div>
                                    <button onClick={createSession} className="mb-4 bg-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow">+ Êñ∞Ë¶è„ÉÜ„Çπ„Éà</button>
                                    <div className="grid gap-4">
                                        {sessions.map(s => (
                                            <div key={s.id} className="bg-white p-6 rounded-xl shadow flex justify-between items-center">
                                                <div><h3 className="font-bold">{s.name}</h3><span className="text-xs bg-gray-100 px-2 py-1 rounded">{s.status}</span></div>
                                                <div className="flex gap-2">
                                                    {s.status === 'standby' && <button onClick={() => toggleStatus(s, 'active')} className="bg-green-500 text-white px-3 py-1 rounded">ÈñãÂßã</button>}
                                                    {s.status === 'active' && <button onClick={() => toggleStatus(s, 'closed')} className="bg-red-500 text-white px-3 py-1 rounded">ÁµÇ‰∫Ü</button>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {teacherTab === 'data' && (
                                <div className="bg-white p-8 rounded-xl shadow text-center">
                                    <button onClick={downloadCSV} className="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold shadow">CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                                </div>
                            )}

                            {teacherTab === 'batch' && (
                                <div className="bg-white p-8 rounded-xl shadow">
                                    <p className="mb-2 text-sm text-gray-600">email, ÂêçÂâç, „ÇØ„É©„Çπ, Áï™Âè∑</p>
                                    <textarea value={batchInput} onChange={e => setBatchInput(e.target.value)} className="w-full h-32 border p-2 rounded mb-4" placeholder="student@example.com, Â±±Áî∞, 3-A, 1"></textarea>
                                    <button onClick={handleBatchRegister} className="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold">ÁôªÈå≤</button>
                                </div>
                            )}

                            {teacherTab === 'students' && (
                                <div className="bg-white p-8 rounded-xl shadow">
                                    <button onClick={clearStudents} className="bg-red-100 text-red-600 px-6 py-3 rounded-lg font-bold border border-red-200">ÂÖ®ÁîüÂæíÂâäÈô§</button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Dashboard
            return (
                <div className="min-h-screen bg-green-50 p-4">
                    <header className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm mb-6 max-w-4xl mx-auto">
                        <div>
                            <h1 className="font-bold text-gray-800">Organic Chem Master</h1>
                            <p className="text-xs text-gray-500">{userData.classId} {userData.name}</p>
                        </div>
                        <div className="flex gap-2">
                            {userData.role === 'teacher' && <button onClick={() => setView('teacher')} className="bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700 text-sm">ÊïôÂì°</button>}
                            <button onClick={handleLogout} className="text-gray-500 text-sm">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto grid md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 className="font-bold text-gray-700 mb-4">üèÜ „Çπ„Çø„É≥„Éó: {userData.stamps}</h2>
                            <div className="flex flex-wrap gap-2 h-32 overflow-y-auto content-start">
                                {[...Array(Math.max(10, userData.stamps + (5 - userData.stamps % 5)))].map((_, i) => (
                                    <div key={i} className={`w-8 h-8 rounded-full flex items-center justify-center border text-xs ${i < userData.stamps ? 'bg-yellow-100 border-yellow-400' : 'border-gray-200'}`}>{i < userData.stamps ? '‚òÖ' : i+1}</div>
                                ))}
                            </div>
                        </div>

                        <div className="space-y-4">
                            <button onClick={startDrill} className="w-full bg-green-500 text-white font-bold p-6 rounded-2xl shadow-lg hover:bg-green-600 transition">
                                üß™ ÊºîÁøí„É¢„Éº„Éâ („Çπ„Çø„Éº„Éà)
                            </button>
                            
                            <button 
                                onClick={startTest} 
                                disabled={!activeSession || activeSession.status !== 'active'}
                                className={`w-full font-bold p-6 rounded-2xl shadow-lg transition ${activeSession && activeSession.status === 'active' ? 'bg-red-500 text-white hover:bg-red-600 animate-pulse' : 'bg-gray-200 text-gray-400'}`}
                            >
                                üìù „ÉÜ„Çπ„Éà„É¢„Éº„Éâ {activeSession && activeSession.status === 'active' ? '(ÂÆüÊñΩ‰∏≠!)' : '(ÂæÖÊ©ü‰∏≠)'}
                            </button>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
